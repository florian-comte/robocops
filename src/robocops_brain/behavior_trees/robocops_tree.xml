<root BTCPP_format="4" main_tree_to_execute="Main">
  <BehaviorTree ID="Main">
    <Sequence>
      <SetLocations name="set_locations" num_locs="{num_locs}" loc_names="{loc_names}" loc_poses="{loc_poses}" />

      <KeepRunningUntilFailure>
        <Fallback name="ZoneSelector">
          <!-- ZONE 3 LOGIC -->
          <Sequence>

            <!-- Check if can go zone 3, SUCCESS = true, FAILURE = false -->
            <CanGoToZone 
              zone_index="2" 
              MAX_INVENTORY="{MAX_INVENTORY}"
              current_inventory="{current_inventory}"
              MIN_TO_GO_ZONES="{MIN_TO_GO_ZONES}"
              TOTAL_ZONES="{TOTAL_ZONES}"
              current_grabbed_zones="{current_grabbed_zones}"
              never_timed_out_zones="{never_timed_out_zones}"
              never_timed_out_opening_door="{never_timed_out_opening_door}"
              />

            <!-- GO TO ZONE 3 LOGIC -->
            <GoToPose name="go_to_open_button" loc_poses="{loc_poses}" loc="button_robot_position" />
                      
            <!-- OPENING DOOR LOGIC -->
            <!-- Check if door is not open, if not try to open -->
            <!-- Return SUCCESS if zone 3 accessible and FAILURE if zone 3 not accessible -->
            <Precondition if="!is_door_open" else="SUCCESS">
                <!-- This sequence returns SUCCESS if can enter the zone and FAILURE if not -->
                <Sequence>
                    <RetryUntilSuccessful num_attempts="3">
                      <Sequence>
                        <!-- Activate button routine -->
                        <BlockingGPIO gpio_name="button" interface_name="active" timeout_duration="15.0" pulse_duration="1.5" wait_after_duration="2.0" />
                                                
                        <!-- Return FAILURE if not open and SUCCESS if open -->
                        <IsDoorOpen timeout_duration="5.0"/>

                        <Script code="is_door_open := true" />
                      </Sequence>
                    </RetryUntilSuccessful>
                </Sequence>
            </Precondition>

            <!-- ENTER ZONE 3 LOGIC -->
            <GoToPose name="go_to_zone3" loc_poses="{loc_poses}" loc="zone3_inside_entry" />

            <!-- GRAB ZONE 3 LOGIC -->
            <!-- <SearchAndGrab zone="3"/> -->

            <!-- LEAVE ZONE 3 LOGIC -->
          </Sequence>

          <!-- ZONE 4 LOGIC -->
          <Sequence>
            
            <!-- Check if can go zone 4, SUCCESS = true, FAILURE = false -->
            <CanGoToZone 
              zone_index="3" 
              MAX_INVENTORY="{MAX_INVENTORY}"
              current_inventory="{current_inventory}"
              MIN_TO_GO_ZONES="{MIN_TO_GO_ZONES}"
              TOTAL_ZONES="{TOTAL_ZONES}"
              current_grabbed_zones="{current_grabbed_zones}"
              never_timed_out_zones="{never_timed_out_zones}"
              never_timed_out_opening_door="{never_timed_out_opening_door}"
              />

            <!-- GO TO ZONE 4 LOGIC -->
            <GoToPose name="go_to_zone4" loc_poses="{loc_poses}" loc="zone4_outside_entry" />

            <!-- ENTER ZONE 4 LOGIC -->
            <BlockingGPIO gpio_name="slope_up" interface_name="active" timeout_duration="15.0" pulse_duration="1.5" wait_after_duration="0.0"/>
            <SetPose name="set_pose_zone4_top" pose="{zone4_inside_entry}" />

            <!-- GRAB ZONE 4 LOGIC -->
        
            <!-- <SearchAndGrab zone="4" /> -->

            <!-- LEAVE ZONE 4 LOGIC -->
            <GoToPose name="exit_position_zone4" loc_poses="{loc_poses}" loc="zone4_inside_entry" />
            <BlockingGPIO gpio_name="slope_down" interface_name="active" timeout_duration="15.0" pulse_duration="1.5" wait_after_duration="0.0"/>
            <SetPose name="set_pose_zone4_bottom" pose="{zone4_outside_entry}" />
          </Sequence>

          <!-- Zone 1 -->
          <Sequence>
              <CanGoToZone 
                zone_index="0" 
                MAX_INVENTORY="{MAX_INVENTORY}"
                current_inventory="{current_inventory}"
                MIN_TO_GO_ZONES="{MIN_TO_GO_ZONES}"
                TOTAL_ZONES="{TOTAL_ZONES}"
                current_grabbed_zones="{current_grabbed_zones}"
                never_timed_out_zones="{never_timed_out_zones}"
                never_timed_out_opening_door="{never_timed_out_opening_door}"/>
            <!-- <SearchAndGrab zone="1" /> -->
          </Sequence>

          <!-- Default Fallback: Drop point -->
          <Sequence>
            <GoToPose name="go_to_zone4" loc_poses="{loc_poses}" loc="drop_point" />
            <BlockingGPIO gpio_name="unload" interface_name="active" timeout_duration="15.0" pulse_duration="1.5" wait_after_duration="1.0"/>
          </Sequence>
          
        </Fallback>
      </KeepRunningUntilFailure>
    </Sequence>
  </BehaviorTree>
</root>
